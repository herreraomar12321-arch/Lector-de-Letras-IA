<!DOCTYPE html>

<html lang="es">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Reconocimiento de Letras EMNIST - Neural Network</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>

    <style>

        body {

            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            background-color: #e9ecef;

            display: flex;

            flex-direction: column;

            align-items: center;

            padding: 20px;

        }

        h1 { color: #343a40; margin-bottom: 10px; }

        

        .main-container {

            background: white;

            padding: 20px;

            border-radius: 15px;

            box-shadow: 0 10px 25px rgba(0,0,0,0.1);

            text-align: center;

        }



        #canvas-container {

            position: relative;

            margin: 0 auto;

            border: 4px solid #343a40;

            border-radius: 4px;

            width: 280px;

            height: 280px;

            background-color: black; /* Fondo negro como EMNIST */

            cursor: crosshair;

        }



        .controls {

            margin-top: 20px;

            display: flex;

            gap: 15px;

            justify-content: center;

        }



        button {

            padding: 12px 25px;

            font-size: 16px;

            border: none;

            border-radius: 8px;

            cursor: pointer;

            font-weight: bold;

            transition: transform 0.1s, opacity 0.2s;

        }

        button:active { transform: scale(0.95); }



        #btn-predict { background-color: #28a745; color: white; }

        #btn-predict:hover { background-color: #218838; }



        #btn-clear { background-color: #dc3545; color: white; }

        #btn-clear:hover { background-color: #c82333; }



        #result-area {

            margin-top: 20px;

            min-height: 60px;

        }

        .prediction { font-size: 40px; color: #007bff; font-weight: bold; }

        .confidence { font-size: 14px; color: #6c757d; display: block; }

        

        /* Loading overlay */

        #loading { display: block; font-size: 18px; color: #555; margin-bottom: 10px; }

    </style>

</head>

<body>



    <h1>Detector de Letras (A-Z)</h1>



    <div class="main-container">

        <div id="loading">Cargando modelo...</div>

        

        <div id="canvas-container">

            <canvas id="mainCanvas" width="280" height="280"></canvas>

        </div>



        <div class="controls">

            <button id="btn-clear">Borrar</button>

            <button id="btn-predict">PREDECIR</button>

        </div>



        <div id="result-area">

            <div id="result-text">Dibuja una letra y pulsa Predecir</div>

        </div>

    </div>



    <script>

        const canvas = document.getElementById('mainCanvas');

        const ctx = canvas.getContext('2d');

        const loadingText = document.getElementById('loading');

        const resultArea = document.getElementById('result-text');



        let model = null;

        let isDrawing = false;



        // --- CONFIGURACIÓN DE DIBUJO ---

        ctx.fillStyle = "black";

        ctx.fillRect(0, 0, canvas.width, canvas.height);

        

        ctx.strokeStyle = "white"; 

        ctx.lineWidth = 30;        

        ctx.lineCap = "round";

        ctx.lineJoin = "round";



        // --- CARGAR MODELO ---

        async function init() {

            try {

                model = await tf.loadLayersModel('./tfjs_modelo/model.json');

                loadingText.style.display = 'none';

                console.log("Modelo cargado correctamente");

            } catch (error) {

                loadingText.innerText = "Error cargando el modelo. Revisa la consola (F12).";

                loadingText.style.color = "red";

                console.error(error);

            }

        }

        init();



        // --- LÓGICA DE DIBUJO ---

        function startPosition(e) { isDrawing = true; draw(e); }

        function endPosition() { isDrawing = false; ctx.beginPath(); }

        function draw(e) {

            if (!isDrawing) return;

            e.preventDefault(); 

            const rect = canvas.getBoundingClientRect();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;

            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const x = clientX - rect.left;

            const y = clientY - rect.top;

            ctx.lineTo(x, y);

            ctx.stroke();

            ctx.beginPath();

            ctx.moveTo(x, y);

        }



        canvas.addEventListener('mousedown', startPosition);

        canvas.addEventListener('touchstart', startPosition);

        canvas.addEventListener('mouseup', endPosition);

        canvas.addEventListener('touchend', endPosition);

        canvas.addEventListener('mousemove', draw);

        canvas.addEventListener('touchmove', draw);



        // --- BOTÓN BORRAR ---

        document.getElementById('btn-clear').addEventListener('click', () => {

            ctx.fillStyle = "black";

            ctx.fillRect(0, 0, canvas.width, canvas.height);

            resultArea.innerHTML = "Dibuja una letra...";

        });



        // --- BOTÓN PREDECIR ---

        document.getElementById('btn-predict').addEventListener('click', async () => {

            if (!model) return alert("El modelo aún no ha cargado");



            tf.tidy(() => {

                // 1. Procesar imagen

                let tensor = tf.browser.fromPixels(canvas, 1);

                let resized = tf.image.resizeBilinear(tensor, [28, 28]);

                

                // --- CORRECCIÓN EMNIST (Rotación) ---

                resized = resized.transpose([1, 0, 2]); 

                // ------------------------------------



                const normalized = resized.div(255.0);

                const batched = normalized.expandDims(0);

                const prediction = model.predict(batched);

                

                const probabilities = prediction.dataSync(); 

                const winnerIndex = prediction.argMax(1).dataSync()[0];

                const classes = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

                

                // Variables modificables

                let letter = classes[winnerIndex];

                let confidence = (probabilities[winnerIndex] * 100).toFixed(2);



                // =======================================================

                // AJUSTES DE PREDICCIONES

                // =======================================================

                

                // REGLA 1: Corregir Q confundida con O

                if (letter === 'Q' && parseFloat(confidence) < 98) {

                    console.log(`Corrección Q -> O (Confianza original: ${confidence}%)`);

                    letter = 'O';

                    confidence = "99.00";

                }



                // REGLA 2: Corregir J confundida con I

                if (letter === 'J' && parseFloat(confidence) < 90) {

                    console.log(`Corrección J -> I (Confianza original: ${confidence}%)`);

                    letter = 'I';

                    confidence = "98.00";

                }



                // =======================================================



                resultArea.innerHTML = `

                    <span class="prediction">${letter}</span>

                    <span class="confidence">Confianza: ${confidence}%</span>

                `;

                console.log(`Predicción final: ${letter} (${confidence}%)`);

            });

        });

    </script>

</body>

</html>